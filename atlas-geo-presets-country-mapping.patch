From db9428bf2bfa0efec087460f133451b2e01a1895 Mon Sep 17 00:00:00 2001
From: dev <dev@example.com>
Date: Fri, 16 Jan 2026 12:16:51 +0000
Subject: [PATCH] atlas: map geo presets to countries

---
 functions/api/atlas/measurements-pair.js | 62 ++++++++++++++++++++++++
 1 file changed, 62 insertions(+)

diff --git a/functions/api/atlas/measurements-pair.js b/functions/api/atlas/measurements-pair.js
index 1a65d86..718dab1 100644
--- a/functions/api/atlas/measurements-pair.js
+++ b/functions/api/atlas/measurements-pair.js
@@ -57,6 +57,52 @@ const PRESET_COUNTRY_NAME_TO_CODE = {
   colombia: "CO",
 };
 
+// For Atlas, using "area" is very coarse (see docs: areas are arbitrary buckets).
+// To make geo presets behave more like users expect, we map macro regions / subregions to a
+// small set of representative ISO country codes, then distribute the requested probes across them.
+//
+// This is intentionally conservative: fewer countries reduces the risk of Atlas returning probes
+// outside the intended region (which can happen with area-based selection).
+const PRESET_REGION_TO_ATLAS_COUNTRIES = {
+  // Macro regions
+  europe: ["GB", "DE", "FR", "NL", "SE", "IT", "PL", "GR"],
+  africa: ["ZA", "NG", "KE", "EG", "MA"],
+  "north america": ["US", "CA", "MX"],
+  "south america": ["BR", "AR", "CL", "CO", "PE"],
+  asia: ["JP", "SG", "IN", "KR", "HK", "AE", "TH", "ID"],
+
+  // Europe (UN M49 subregions)
+  "western europe": ["GB", "IE", "FR", "BE", "NL", "DE", "CH"],
+  "northern europe": ["SE", "NO", "FI", "DK", "IS"],
+  "southern europe": ["IT", "ES", "PT", "GR", "HR"],
+  "eastern europe": ["PL", "CZ", "HU", "RO", "UA"],
+
+  // Africa (UN M49 subregions)
+  "northern africa": ["MA", "DZ", "TN", "EG"],
+  "western africa": ["NG", "GH", "SN", "CI"],
+  "middle africa": ["CM", "GA", "AO"],
+  "eastern africa": ["KE", "ET", "TZ", "UG"],
+  "southern africa": ["ZA", "NA", "BW"],
+
+  // Americas
+  "northern america": ["US", "CA"],
+  "central america": ["MX", "GT", "CR", "PA"],
+  caribbean: ["DO", "PR", "JM", "TT"],
+
+  // Asia (UN M49 subregions)
+  "western asia": ["AE", "SA", "TR", "IL", "JO"],
+  "central asia": ["KZ", "UZ", "KG"],
+  "southern asia": ["IN", "PK", "BD", "LK"],
+  "south-eastern asia": ["SG", "TH", "VN", "MY", "ID", "PH"],
+  "eastern asia": ["JP", "KR", "TW", "HK"],
+
+  // Oceania moved under Asia in the UI
+  "australia and new zealand": ["AU", "NZ"],
+  melanesia: ["FJ", "PG"],
+  micronesia: ["FM", "MH"],
+  polynesia: ["WS", "TO"],
+};
+
 // ping6.it geo presets use UN M49 region labels (e.g. "Asia", "Western Europe").
 // RIPE Atlas probe selection does not support those directly, so we map them to Atlas "area" buckets.
 // This is an approximation (Atlas areas are coarse).
@@ -118,12 +164,28 @@ function presetToAtlasProbeSelection(label, requested, warnings) {
   const key = raw.toLowerCase();
   if (!key) return null;
 
+  // Exact country name presets (Brazil, Argentina, ...)
   const cc = PRESET_COUNTRY_NAME_TO_CODE[key];
   if (cc) {
     warnings.push(`Mapped preset "${raw}" to RIPE Atlas country=${cc}.`);
     return { probes: [{ requested, type: "country", value: cc }], warnings };
   }
 
+  // Prefer country-based mappings for macro regions/subregions.
+  const countryCodes = PRESET_REGION_TO_ATLAS_COUNTRIES[key];
+  if (Array.isArray(countryCodes) && countryCodes.length) {
+    const want = Math.max(1, Math.trunc(Number(requested) || 1));
+    const used = countryCodes.slice(0, Math.min(countryCodes.length, want));
+    const counts = distributeRequested(want, used.length);
+    const usedCodes = used.slice(0, counts.length);
+    const probes = usedCodes.map((c, i) => ({ requested: counts[i], type: "country", value: c }));
+    warnings.push(
+      `Mapped preset "${raw}" to RIPE Atlas countr${usedCodes.length > 1 ? "ies" : "y"}: ${usedCodes.join(", ")}. (This is a curated subset for the region.)`
+    );
+    return { probes, warnings };
+  }
+
+  // Fallback: area buckets. These are *very* coarse and may include probes outside the intended region.
   const areas = PRESET_REGION_TO_ATLAS_AREAS[key];
   if (Array.isArray(areas) && areas.length) {
     const counts = distributeRequested(requested, areas.length);
-- 
2.39.5

